# Promtail Configuration
# Log shipping agent for Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # ========================================
  # API Service Logs (Node.js/Fastify)
  # ========================================
  - job_name: api
    static_configs:
      - targets:
          - localhost
        labels:
          job: api
          service: api
          app: shabou-autopieces
          __path__: /var/log/api/*.log
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: time
            level: level
            message: msg
            request_id: requestId
            user_id: userId
            method: method
            path: path
            status_code: statusCode
            duration: duration
      # Convert timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      # Extract labels
      - labels:
          level:
          request_id:
          method:
          status_code:
      # Add severity label
      - template:
          source: severity
          template: '{{ .level }}'
      - labels:
          severity:

  # ========================================
  # Prospector Agent Logs (Python/FastAPI)
  # ========================================
  - job_name: prospector
    static_configs:
      - targets:
          - localhost
        labels:
          job: prospector
          service: prospector
          app: shabou-autopieces
          __path__: /var/log/prospector/*.log
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            source: source
            lead_id: lead_id
            url: url
      # Convert timestamp
      - timestamp:
          source: timestamp
          format: RFC3339
      # Extract labels
      - labels:
          level:
          source:
      # Add severity label
      - template:
          source: severity
          template: '{{ .level }}'
      - labels:
          severity:

  # ========================================
  # Orion Agent Logs (Python/FastAPI)
  # ========================================
  - job_name: orion
    static_configs:
      - targets:
          - localhost
        labels:
          job: orion
          service: orion
          app: shabou-autopieces
          __path__: /var/log/orion/*.log
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            model_type: model_type
            forecast_id: forecast_id
            accuracy: accuracy
      # Convert timestamp
      - timestamp:
          source: timestamp
          format: RFC3339
      # Extract labels
      - labels:
          level:
          model_type:
      # Add severity label
      - template:
          source: severity
          template: '{{ .level }}'
      - labels:
          severity:

  # ========================================
  # Celery Worker Logs
  # ========================================
  - job_name: celery-prospector
    static_configs:
      - targets:
          - localhost
        labels:
          job: celery-prospector
          service: prospector-worker
          app: shabou-autopieces
          __path__: /var/log/celery/prospector/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            task: task
      - timestamp:
          source: timestamp
          format: RFC3339
      - labels:
          level:
          task:

  - job_name: celery-orion
    static_configs:
      - targets:
          - localhost
        labels:
          job: celery-orion
          service: orion-worker
          app: shabou-autopieces
          __path__: /var/log/celery/orion/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            task: task
      - timestamp:
          source: timestamp
          format: RFC3339
      - labels:
          level:
          task:

  # ========================================
  # PostgreSQL Logs
  # ========================================
  - job_name: postgres
    static_configs:
      - targets:
          - localhost
        labels:
          job: postgres
          service: postgres
          app: shabou-autopieces
          __path__: /var/log/postgresql/*.log
    pipeline_stages:
      # PostgreSQL log format is not JSON, use regex
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3} \w+) \[(?P<pid>\d+)\] (?P<level>\w+):  (?P<message>.*)$'
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05.000 MST'
      - labels:
          level:
          pid:

  # ========================================
  # Redis Logs
  # ========================================
  - job_name: redis
    static_configs:
      - targets:
          - localhost
        labels:
          job: redis
          service: redis
          app: shabou-autopieces
          __path__: /var/log/redis/*.log
    pipeline_stages:
      # Redis log format
      - regex:
          expression: '^(?P<pid>\d+):(?P<role>\w) (?P<timestamp>\d{2} \w+ \d{4} \d{2}:\d{2}:\d{2}\.\d{3}) (?P<level>[*#.-]) (?P<message>.*)$'
      - timestamp:
          source: timestamp
          format: '02 Jan 2006 15:04:05.000'
      - labels:
          level:
          role:
