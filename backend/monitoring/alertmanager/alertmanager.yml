# Alertmanager Configuration
# Alert routing and notification management for Shabou Auto Pi√®ces

global:
  # Default SMTP configuration (email notifications)
  smtp_from: 'alerts@shabou-autopieces.com'
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com}:587'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack webhook URL (if using Slack)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # PagerDuty (if using PagerDuty)
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

  # Resolve timeout - how long to wait before auto-resolving an alert
  resolve_timeout: 5m

# Templates for custom alert messages
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route configuration - defines how alerts are routed to receivers
route:
  # Default receiver for all alerts
  receiver: 'default'

  # Group alerts by these labels to reduce noise
  group_by: ['alertname', 'service', 'severity']

  # Wait time before sending the first notification
  group_wait: 30s

  # Wait time before sending notifications about new alerts in the same group
  group_interval: 5m

  # Minimum time between notifications for the same alert
  repeat_interval: 4h

  # Child routes for specific alert types
  routes:
    # ========================================
    # Critical Alerts - Immediate notification
    # ========================================
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 30m
      continue: true  # Also send to default receiver

    # ========================================
    # Warning Alerts - Standard notification
    # ========================================
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

    # ========================================
    # Infrastructure Alerts
    # ========================================
    - match_re:
        alertname: 'High(CPU|Memory|Disk)Usage|ServiceDown'
      receiver: 'infrastructure-team'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h

    # ========================================
    # Database Alerts
    # ========================================
    - match_re:
        alertname: 'PostgreSQL.*|DatabaseDown|HighConnectionCount'
      receiver: 'database-team'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 2h

    # ========================================
    # Application Errors
    # ========================================
    - match_re:
        alertname: 'HighErrorRate|High.*ErrorRate'
      receiver: 'backend-team'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h

# Inhibit rules - suppress certain alerts when others are firing
inhibit_rules:
  # Suppress warning alerts if critical alert is firing for the same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']

  # Suppress all alerts if service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.*'
    equal: ['service', 'instance']

# Receivers - notification destinations
receivers:
  # ========================================
  # Default Receiver (Email)
  # ========================================
  - name: 'default'
    email_configs:
      - to: '${ALERT_EMAIL_DEFAULT:-ops@shabou-autopieces.com}'
        headers:
          Subject: '[Shabou] {{ .GroupLabels.alertname }} - {{ .GroupLabels.severity }}'
        html: '{{ template "email.default.html" . }}'
        send_resolved: true

  # ========================================
  # Critical Alerts (Email + Slack + PagerDuty)
  # ========================================
  - name: 'critical-alerts'
    email_configs:
      - to: '${ALERT_EMAIL_CRITICAL:-oncall@shabou-autopieces.com}'
        headers:
          Subject: 'üö® [CRITICAL] {{ .GroupLabels.alertname }}'
          Priority: 'high'
        html: '{{ template "email.critical.html" . }}'
        send_resolved: true

    slack_configs:
      - channel: '#alerts-critical'
        username: 'Alertmanager'
        icon_emoji: ':rotating_light:'
        title: 'üö® Critical Alert: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.critical.text" . }}'
        send_resolved: true
        actions:
          - type: button
            text: 'View in Grafana'
            url: '{{ .ExternalURL }}'
          - type: button
            text: 'Runbook'
            url: 'https://docs.shabou-autopieces.com/runbooks/{{ .GroupLabels.alertname }}'

    # Uncomment to enable PagerDuty
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     description: '{{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
    #     severity: 'critical'

  # ========================================
  # Warning Alerts (Email + Slack)
  # ========================================
  - name: 'warning-alerts'
    email_configs:
      - to: '${ALERT_EMAIL_WARNING:-team@shabou-autopieces.com}'
        headers:
          Subject: '‚ö†Ô∏è  [WARNING] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'
        send_resolved: true

    slack_configs:
      - channel: '#alerts-warning'
        username: 'Alertmanager'
        icon_emoji: ':warning:'
        title: '‚ö†Ô∏è Warning: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.default.text" . }}'
        send_resolved: true

  # ========================================
  # Infrastructure Team
  # ========================================
  - name: 'infrastructure-team'
    email_configs:
      - to: '${ALERT_EMAIL_INFRA:-infra@shabou-autopieces.com}'
        headers:
          Subject: '[Infrastructure] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'
        send_resolved: true

    slack_configs:
      - channel: '#team-infrastructure'
        username: 'Alertmanager'
        icon_emoji: ':computer:'
        title: 'üñ•Ô∏è Infrastructure Alert: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.default.text" . }}'
        send_resolved: true

  # ========================================
  # Database Team
  # ========================================
  - name: 'database-team'
    email_configs:
      - to: '${ALERT_EMAIL_DB:-dba@shabou-autopieces.com}'
        headers:
          Subject: '[Database] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'
        send_resolved: true

    slack_configs:
      - channel: '#team-database'
        username: 'Alertmanager'
        icon_emoji: ':floppy_disk:'
        title: 'üíæ Database Alert: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.default.text" . }}'
        send_resolved: true

  # ========================================
  # Backend Team
  # ========================================
  - name: 'backend-team'
    email_configs:
      - to: '${ALERT_EMAIL_BACKEND:-backend@shabou-autopieces.com}'
        headers:
          Subject: '[Backend] {{ .GroupLabels.alertname }}'
        html: '{{ template "email.default.html" . }}'
        send_resolved: true

    slack_configs:
      - channel: '#team-backend'
        username: 'Alertmanager'
        icon_emoji: ':gear:'
        title: '‚öôÔ∏è Backend Alert: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.default.text" . }}'
        send_resolved: true
